<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ألعاب كمبيوتر - تحميل أفضل الألعاب مجاناً</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
</head>
<body class="dark-mode">
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">ألعاب كمبيوتر</div>
                <nav>
                    <ul>
                        <li><a href="#" class="active">الرئيسية</a></li>
                        <li><a href="#all-games">جميع الألعاب</a></li>
                        <li><a href="#top-games">الأكثر تحميلاً</a></li>
                        <li><a href="#categories">التصنيفات</a></li>
                    </ul>
                </nav>
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </header>
    
    <section class="hero">
        <div class="container hero-container">
            <h1>اكتشف عالم الألعاب المذهل</h1>
            <p>تحميل أحدث الألعاب بسهولة وسرعة</p>
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="ابحث عن لعبتك المفضلة..." autocomplete="off">
                <div class="search-suggestions" id="searchSuggestions"></div>
                <div class="search-results-count" id="searchResultsCount"></div>
            </div>
        </div>
    </section>
    
    <section class="game-section" id="latest-games">
        <div class="container">
            <h2 class="section-title">أحدث الألعاب</h2>
            <div class="games-grid" id="latestGamesContainer">
                <!-- سيتم ملؤه بواسطة JavaScript -->
            </div>
        </div>
    </section>
    
    <section class="game-section" id="top-games">
        <div class="container">
            <h2 class="section-title">الأكثر تحميلاً</h2>
            <div class="games-grid" id="topDownloadsContainer">
                <!-- سيتم ملؤه بواسطة JavaScript -->
            </div>
        </div>
    </section>
    
    <section class="game-section" id="all-games">
        <div class="container">
            <h2 class="section-title">جميع الألعاب</h2>
            <div class="filters">
                <select id="categoryFilter">
                    <option value="all">جميع التصنيفات</option>
                    <option value="sports">رياضة</option>
                    <option value="action">أكشن</option>
                    <option value="adventure">مغامرات</option>
                    <option value="racing">سباقات</option>
                    <option value="strategy">إستراتيجية</option>
                </select>
                <select id="sortBy">
                    <option value="newest">الأحدث</option>
                    <option value="oldest">الأقدم</option>
                    <option value="downloads">الأكثر تحميلاً</option>
                </select>
            </div>
            <div class="games-grid" id="allGamesContainer">
                <!-- سيتم ملؤه بواسطة JavaScript -->
            </div>
            <div class="pagination" id="paginationContainer">
                <!-- سيتم ملؤه بواسطة JavaScript -->
            </div>
        </div>
    </section>
    
    <section id="game-details-section" style="display:none;">
        <div class="container">
            <div class="game-page">
                <div class="game-header" id="gameDetailsContainer">
                    <!-- سيتم ملؤه بواسطة JavaScript -->
                </div>
                
                <div class="screenshots">
                    <h2 class="section-title">لقطات من اللعبة</h2>
                    <div class="screenshots-grid" id="screenshotsContainer">
                        <!-- سيتم ملؤه بواسطة JavaScript -->
                    </div>
                </div>
                
                <div class="comments-section">
                    <h2 class="section-title">التعليقات</h2>
                    <div class="comment-form">
                        <textarea id="commentInput" placeholder="أضف تعليقك هنا..." rows="4"></textarea>
                        <label class="admin-checkbox">
                            <input type="checkbox" id="adminComment"> تعليق كمشرف
                        </label>
                        <button class="submit-comment-btn" onclick="submitComment()">إرسال التعليق</button>
                    </div>
                    <div class="comments-list" id="commentsContainer">
                        <!-- سيتم ملؤه بواسطة JavaScript -->
                    </div>
                </div>
                
                <div class="similar-games">
                    <h2 class="section-title">ألعاب مشابهة</h2>
                    <div class="games-grid" id="similarGamesContainer">
                        <!-- سيتم ملؤه بواسطة JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <section id="not-found-section" style="display:none;">
        <div class="container">
            <div class="not-found">
                <h1>404</h1>
                <p>الصفحة التي تبحث عنها غير موجودة</p>
                <a href="#" class="home-btn" onclick="goHome(); return false;">العودة إلى الرئيسية</a>
            </div>
        </div>
    </section>
    
    <a href="#" class="back-to-top" id="backToTop"><i class="fas fa-arrow-up"></i></a>
    
    <footer>
        <div class="container">
            <div class="footer-links">
                <a href="#" onclick="goHome(); return false;">سياسة الخصوصية</a>
                <a href="#" onclick="goHome(); return false;">شروط الاستخدام</a>
                <a href="#" onclick="goHome(); return false;">اتصل بنا</a>
                <a href="#" onclick="goHome(); return false;">عن الموقع</a>
                <button class="whatsapp-btn" onclick="window.open('https://wa.me/+21260717742940?text=مرحبًا، أنا أواجه مشكلة في موقع تحميل الالعاب', '_blank')">
                    <i class="fab fa-whatsapp"></i> التواصل مع المشرف
                </button>
            </div>
            <p class="copyright">جميع الحقوق محفوظة © <span id="year"></span> ألعاب كمبيوتر</p>
        </div>
    </footer>

    <script src="shortcuts.js"></script>
    <script>
        // إعدادات التطبيق
        const config = {
            gamesPerPage: 8,
            currentPage: 1,
            allGames: [],
            filteredGames: [],
            adminCode: '852258'
        };

        // تحميل الألعاب من ملف JSON
        async function loadGames() {
            try {
                const response = await fetch('games.json');
                if (!response.ok) {
                    throw new Error('تعذر تحميل قائمة الألعاب');
                }
                const games = await response.json();
                if (!Array.isArray(games) || games.length === 0) {
                    throw new Error('قائمة الألعاب فارغة');
                }
                console.log('تم تحميل الألعاب:', games);
                return games;
            } catch (error) {
                console.error('خطأ في تحميل الألعاب:', error);
                const container = document.getElementById('allGamesContainer');
                if (container) {
                    container.innerHTML = `<p style="text-align: center; color: var(--primary);">تعذر تحميل الألعاب. الرجاء المحاولة لاحقاً.</p>`;
                }
                return [];
            }
        }

        // دالة لتحميل ملف الوصف
        async function loadDescription(filename) {
            try {
                const response = await fetch(`descriptions/${filename}`);
                if (!response.ok) {
                    throw new Error('لم يتم العثور على ملف الوصف');
                }
                return await response.text();
            } catch (error) {
                console.error('خطأ في تحميل الوصف:', error);
                return `<p>تعذر تحميل وصف اللعبة. ${error.message}</p>`;
            }
        }

        // دالة لعرض الألعاب في الشبكة
        function displayGames(gamesArray, containerId, page = 1, append = false, highlightId = null) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`العنصر ${containerId} غير موجود`);
                return;
            }
            
            if (!append) {
                container.innerHTML = '';
            }
            
            const startIndex = (page - 1) * config.gamesPerPage;
            const endIndex = startIndex + config.gamesPerPage;
            const paginatedGames = gamesArray.slice(startIndex, endIndex);
            
            if (paginatedGames.length === 0 && !append) {
                container.innerHTML = '<p style="text-align: center;">لا توجد ألعاب متاحة.</p>';
                return;
            }
            
            paginatedGames.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = `game-card fade-in ${highlightId === game.id ? 'highlight' : ''}`;
                gameCard.setAttribute('data-id', game.id);
                gameCard.innerHTML = `
                    <a href="#" onclick="showGameDetails(${game.id}); return false;">
                        <div class="game-card-inner">
                            <div class="game-img-container">
                                <img src="${game.cover}" alt="${game.title}" class="game-img" loading="lazy">
                            </div>
                            <div class="game-info">
                                <h3 class="game-title">${game.title}</h3>
                                <div class="game-meta">
                                    <span>${game.size}</span>
                                    <span>${game.downloads.toLocaleString()} تحميل</span>
                                </div>
                                <a href="#" onclick="showGameDetails(${game.id}); return false;" class="download-btn">التفاصيل</a>
                            </div>
                        </div>
                    </a>
                `;
                container.appendChild(gameCard);
            });
            
            if (containerId === 'allGamesContainer') {
                renderPagination(gamesArray, page);
            }

            if (highlightId) {
                const highlightedCard = container.querySelector(`.game-card[data-id="${highlightId}"]`);
                if (highlightedCard) {
                    highlightedCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // دالة لعرض أزرار التقسيم
        function renderPagination(gamesArray, currentPage) {
            const paginationContainer = document.getElementById('paginationContainer');
            if (!paginationContainer) return;
            
            paginationContainer.innerHTML = '';
            
            const totalPages = Math.ceil(gamesArray.length / config.gamesPerPage);
            if (totalPages <= 1) return;
            
            const pagination = document.createElement('div');
            pagination.className = 'pagination-buttons';
            
            const prevButton = document.createElement('button');
            prevButton.className = 'pagination-btn';
            prevButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    config.currentPage = currentPage - 1;
                    displayGames(gamesArray, 'allGamesContainer', config.currentPage);
                    window.scrollTo({ top: document.getElementById('all-games').offsetTop, behavior: 'smooth' });
                }
            });
            pagination.appendChild(prevButton);
            
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageButton.textContent = i;
                pageButton.addEventListener('click', () => {
                    config.currentPage = i;
                    displayGames(gamesArray, 'allGamesContainer', config.currentPage);
                    window.scrollTo({ top: document.getElementById('all-games').offsetTop, behavior: 'smooth' });
                });
                pagination.appendChild(pageButton);
            }
            
            const nextButton = document.createElement('button');
            nextButton.className = 'pagination-btn';
            nextButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    config.currentPage = currentPage + 1;
                    displayGames(gamesArray, 'allGamesContainer', config.currentPage);
                    window.scrollTo({ top: document.getElementById('all-games').offsetTop, behavior: 'smooth' });
                }
            });
            pagination.appendChild(nextButton);
            
            paginationContainer.appendChild(pagination);
        }

        // دالة البحث الذكي مع الاقتراحات
        function smartSearch(searchTerm, forSuggestions = false) {
            const resultsCountElement = document.getElementById('searchResultsCount');
            const suggestionsContainer = document.getElementById('searchSuggestions');
            
            if (!searchTerm.trim()) {
                if (resultsCountElement) resultsCountElement.textContent = '';
                if (suggestionsContainer) {
                    suggestionsContainer.innerHTML = '';
                    suggestionsContainer.style.display = 'none';
                }
                return config.allGames;
            }
            
            const normalizedSearch = searchTerm.toLowerCase().trim();
            console.log('البحث عن:', normalizedSearch);
            
            let fullSearchTerm = searchTerm;
            
            try {
                if (window.shortcuts && typeof window.shortcuts === 'object' && typeof Fuse !== 'undefined') {
                    const shortcutArray = Object.keys(window.shortcuts).map(key => ({
                        key,
                        value: window.shortcuts[key]
                    }));
                    console.log('مفاتيح shortcuts:', shortcutArray);
                    
                    const shortcutFuse = new Fuse(shortcutArray, {
                        keys: ['key'],
                        threshold: 0.5,
                        includeScore: true,
                        minMatchCharLength: 1
                    });
                    
                    const shortcutResults = shortcutFuse.search(normalizedSearch);
                    console.log('نتائج بحث shortcuts:', shortcutResults);
                    
                    if (shortcutResults.length > 0) {
                        fullSearchTerm = shortcutResults[0].item.value;
                        console.log('اختصار مطابق:', fullSearchTerm);
                    }
                } else {
                    console.warn('Fuse.js أو shortcuts.js غير محملين، يتم استخدام البحث الأساسي');
                }
            } catch (error) {
                console.error('خطأ في البحث في shortcuts:', error);
            }
            
            if (window.shortcuts && fullSearchTerm === searchTerm) {
                for (const shortcut in window.shortcuts) {
                    if (shortcut.toLowerCase().includes(normalizedSearch)) {
                        fullSearchTerm = window.shortcuts[shortcut];
                        console.log('اختصار مطابق (includes):', fullSearchTerm);
                        break;
                    }
                }
            }
            
            let results = [];
            try {
                if (typeof Fuse !== 'undefined' && config.allGames.length > 0) {
                    const gameFuse = new Fuse(config.allGames, {
                        keys: ['title', 'category'],
                        threshold: forSuggestions ? 0.3 : 0.4,
                        includeScore: true,
                        minMatchCharLength: forSuggestions ? 1 : 2
                    });
                    results = gameFuse.search(fullSearchTerm).map(result => result.item);
                } else {
                    results = config.allGames.filter(game => 
                        game.title.toLowerCase().includes(normalizedSearch) ||
                        game.category.toLowerCase().includes(normalizedSearch)
                    );
                }
                console.log('نتائج بحث الألعاب:', results);
            } catch (error) {
                console.error('خطأ في البحث في الألعاب:', error);
                results = config.allGames.filter(game => 
                    game.title.toLowerCase().includes(normalizedSearch) ||
                    game.category.toLowerCase().includes(normalizedSearch)
                );
            }
            
            if (!forSuggestions && resultsCountElement) {
                resultsCountElement.textContent = results.length > 0 
                    ? `تم العثور على ${results.length} نتيجة`
                    : 'لم يتم العثور على أي نتائج';
                if (suggestionsContainer) {
                    suggestionsContainer.innerHTML = '';
                    suggestionsContainer.style.display = 'none';
                }
            } else if (suggestionsContainer) {
                suggestionsContainer.innerHTML = '';
                const suggestionItems = results.slice(0, 5).map(game => `
                    <div class="suggestion-item" data-id="${game.id}">
                        <img src="${game.cover}" alt="${game.title}" class="suggestion-img">
                        <span>${game.title}</span>
                    </div>
                `).join('');
                suggestionsContainer.innerHTML = suggestionItems || '<div class="suggestion-item no-results">لا توجد اقتراحات</div>';
                suggestionsContainer.style.display = suggestionItems ? 'block' : 'none';
                
                suggestionsContainer.querySelectorAll('.suggestion-item:not(.no-results)').forEach(item => {
                    item.addEventListener('click', () => {
                        const gameId = item.getAttribute('data-id');
                        const searchInput = document.getElementById('searchInput');
                        const selectedGame = config.allGames.find(g => g.id == gameId);
                        if (selectedGame && searchInput) {
                            searchInput.value = selectedGame.title;
                            performSearch(selectedGame.title, gameId);
                        }
                    });
                });
            }
            
            return results;
        }

        // تنفيذ البحث والتنقل
        function performSearch(searchTerm, highlightId = null) {
            try {
                config.filteredGames = smartSearch(searchTerm);
                config.currentPage = 1;
                displayGames(config.filteredGames, 'allGamesContainer', config.currentPage, false, highlightId);
                const allGamesSection = document.getElementById('all-games');
                if (allGamesSection) {
                    allGamesSection.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('خطأ في تنفيذ البحث:', error);
            }
        }

        // إدارة الاسم
        function getUserName() {
            let userName = localStorage.getItem('userName');
            if (!userName) {
                userName = prompt('أدخل اسمك للتعليق (سيُستخدم في جميع تعليقاتك):');
                if (!userName || userName.trim() === '') {
                    alert('يجب إدخال اسم للتعليق.');
                    return null;
                }
                userName = userName.trim();
                localStorage.setItem('userName', userName);
            }
            return userName;
        }

        // إدارة التعليقات
        function loadComments(gameId) {
            const comments = JSON.parse(localStorage.getItem(`comments_${gameId}`)) || [];
            return comments;
        }

        function saveComments(gameId, comments) {
            localStorage.setItem(`comments_${gameId}`, JSON.stringify(comments));
        }

        function displayComments(gameId) {
            const commentsContainer = document.getElementById('commentsContainer');
            if (!commentsContainer) return;

            const comments = loadComments(gameId);
            commentsContainer.innerHTML = '';

            if (comments.length === 0) {
                commentsContainer.innerHTML = '<p class="no-comments">لا توجد تعليقات بعد.</p>';
                return;
            }

            comments.forEach((comment, index) => {
                const isLiked = localStorage.getItem(`like_${gameId}_${index}`) === 'true';
                const commentElement = document.createElement('div');
                commentElement.className = `comment ${comment.isAdmin ? 'admin-comment' : ''}`;
                commentElement.setAttribute('data-comment-id', index);
                commentElement.innerHTML = `
                    <div class="comment-header">
                        <span class="comment-author">${comment.isAdmin ? 'المشرف' : comment.author}</span>
                        <span class="comment-date">${new Date(comment.date).toLocaleString('ar-EG')}</span>
                    </div>
                    <p class="comment-text">${comment.text}</p>
                    <div class="comment-actions">
                        <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="likeComment(${gameId}, ${index})">
                            <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${comment.likes || 0}
                        </button>
                        <button class="reply-btn" onclick="showReplyForm(${gameId}, ${index})">رد</button>
                    </div>
                    <div class="reply-form" id="reply-form-${index}" style="display: none;">
                        <textarea class="reply-input" placeholder="أضف ردك هنا..." rows="3"></textarea>
                        <button class="submit-reply-btn" onclick="submitReply(${gameId}, ${index})">إرسال الرد</button>
                    </div>
                    <div class="replies">
                        ${comment.replies ? comment.replies.map(reply => `
                            <div class="reply">
                                <div class="comment-header">
                                    <span class="comment-author">${reply.isAdmin ? 'المشرف' : reply.author}</span>
                                    <span class="comment-date">${new Date(reply.date).toLocaleString('ar-EG')}</span>
                                </div>
                                <p class="comment-text">${reply.text}</p>
                            </div>
                        `).join('') : ''}
                    </div>
                `;
                commentsContainer.appendChild(commentElement);
            });
        }

        function submitComment() {
            const commentInput = document.getElementById('commentInput');
            const adminComment = document.getElementById('adminComment').checked;
            const gameId = document.querySelector('#game-details-section').dataset.gameId;

            if (!commentInput.value.trim()) {
                alert('يرجى كتابة تعليق قبل الإرسال.');
                return;
            }

            const userName = getUserName();
            if (!userName) return;

            if (adminComment) {
                const code = prompt('أدخل كود المشرف:');
                if (code !== config.adminCode) {
                    alert('كود المشرف غير صحيح!');
                    return;
                }
            }

            const comment = {
                text: commentInput.value.trim(),
                author: userName,
                isAdmin: adminComment,
                date: new Date().toISOString(),
                likes: 0,
                replies: []
            };

            const comments = loadComments(gameId);
            comments.push(comment);
            saveComments(gameId, comments);

            commentInput.value = '';
            document.getElementById('adminComment').checked = false;
            displayComments(gameId);
        }

        function likeComment(gameId, commentIndex) {
            const comments = loadComments(gameId);
            const likeKey = `like_${gameId}_${commentIndex}`;
            const isLiked = localStorage.getItem(likeKey) === 'true';

            if (!isLiked) {
                comments[commentIndex].likes = (comments[commentIndex].likes || 0) + 1;
                localStorage.setItem(likeKey, 'true');
            } else {
                comments[commentIndex].likes = Math.max(0, (comments[commentIndex].likes || 0) - 1);
                localStorage.setItem(likeKey, 'false');
            }

            saveComments(gameId, comments);
            displayComments(gameId);
        }

        function showReplyForm(gameId, commentIndex) {
            const replyForm = document.getElementById(`reply-form-${commentIndex}`);
            replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
        }

        function submitReply(gameId, commentIndex) {
            const replyInput = document.querySelector(`#reply-form-${commentIndex} .reply-input`);
            if (!replyInput.value.trim()) {
                alert('يرجى كتابة رد قبل الإرسال.');
                return;
            }

            const userName = getUserName();
            if (!userName) return;

            const comments = loadComments(gameId);
            const reply = {
                text: replyInput.value.trim(),
                author: userName,
                isAdmin: false,
                date: new Date().toISOString()
            };

            comments[commentIndex].replies = comments[commentIndex].replies || [];
            comments[commentIndex].replies.push(reply);
            saveComments(gameId, comments);

            replyInput.value = '';
            displayComments(gameId);
        }

        // عرض صفحة تفاصيل اللعبة
        async function showGameDetails(gameId) {
            const game = config.allGames.find(g => g.id === gameId);
            
            if (!game) {
                showNotFound();
                return;
            }
            
            document.querySelectorAll('section').forEach(section => {
                section.style.display = 'none';
            });
            
            const gameDetailsSection = document.getElementById('game-details-section');
            gameDetailsSection.style.display = 'block';
            gameDetailsSection.dataset.gameId = gameId;
            
            const gameDetailsContainer = document.getElementById('gameDetailsContainer');
            gameDetailsContainer.innerHTML = `
                <div class="game-poster-container">
                    <img src="${game.poster}" alt="${game.title}" class="game-poster" loading="lazy">
                </div>
                <div class="game-details">
                    <h1 class="game-name">${game.title}</h1>
                    <div class="game-description">
                        <div class="loading"></div> جاري تحميل الوصف...
                    </div>
                    <div class="game-meta-info">
                        <div class="meta-item"><span>الحجم:</span> ${game.size}</div>
                        <div class="meta-item"><span>عدد التحميلات:</span> ${game.downloads.toLocaleString()}</div>
                        <div class="meta-item"><span>تاريخ الإصدار:</span> ${new Date(game.date).toLocaleDateString('ar-EG')}</div>
                        <div class="meta-item"><span>التصنيف:</span> ${getCategoryName(game.category)}</div>
                    </div>
                    <div class="game-specs">
                        <h3 class="specs-title">متطلبات النظام:</h3>
                        <ul class="specs-list">
                            <li>نظام التشغيل: ${game.requirements.os}</li>
                            <li>المعالج: ${game.requirements.processor}</li>
                            <li>الذاكرة: ${game.requirements.memory}</li>
                            <li>كرت الشاشة: ${game.requirements.graphics}</li>
                            <li>مساحة التخزين: ${game.requirements.storage}</li>
                        </ul>
                    </div>
                    <a href="${game.downloadLink}" class="main-download-btn">تحميل اللعبة</a>
                </div>
            `;
            
            try {
                const description = await loadDescription(game.descriptionFile);
                const descriptionElement = document.querySelector('#gameDetailsContainer .game-description');
                if (descriptionElement) {
                    descriptionElement.innerHTML = description;
                }
            } catch (error) {
                const descriptionElement = document.querySelector('#gameDetailsContainer .game-description');
                if (descriptionElement) {
                    descriptionElement.innerHTML = `<p>حدث خطأ أثناء تحميل وصف اللعبة: ${error.message}</p>`;
                }
            }
            
            const screenshotsContainer = document.getElementById('screenshotsContainer');
            screenshotsContainer.innerHTML = '';
            
            game.screenshots.forEach(screenshot => {
                const screenshotElement = document.createElement('div');
                screenshotElement.className = 'screenshot';
                screenshotElement.innerHTML = `
                    <img src="${screenshot}" alt="${game.title} screenshot" loading="lazy">
                `;
                screenshotElement.addEventListener('click', () => openModal(screenshot));
                screenshotsContainer.appendChild(screenshotElement);
            });
            
            displayComments(gameId);
            
            const similarGamesContainer = document.getElementById('similarGamesContainer');
            similarGamesContainer.innerHTML = '';
            
            const similarGames = config.allGames.filter(g => game.similar && game.similar.includes(g.id));
            if (similarGames.length > 0) {
                displayGames(similarGames, 'similarGamesContainer');
            } else {
                similarGamesContainer.innerHTML = '<p>لا توجد ألعاب مشابهة حالياً</p>';
            }
            
            window.scrollTo(0, 0);
        }

        // الحصول على اسم التصنيف
        function getCategoryName(category) {
            const categories = {
                'sports': 'رياضة',
                'action': 'أكشن',
                'adventure': 'مغامرات',
                'racing': 'سباقات',
                'strategy': 'إستراتيجية'
            };
            return categories[category] || category;
        }

        // عرض الصورة في نموذج كبير
        function openModal(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <span class="close" onclick="this.parentElement.style.display='none'">×</span>
                <img class="modal-content" src="${imageSrc}">
            `;
            
            document.body.appendChild(modal);
            
            modal.style.display = 'block';
            
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    modal.remove();
                }
            });
        }

        // عرض صفحة 404
        function showNotFound() {
            document.querySelectorAll('section').forEach(section => {
                section.style.display = 'none';
            });
            
            const notFoundSection = document.getElementById('not-found-section');
            notFoundSection.style.display = 'block';
            
            window.scrollTo(0, 0);
        }

        // العودة إلى الصفحة الرئيسية
        function goHome() {
            console.log('تنفيذ goHome: إعادة عرض الصفحة الرئيسية');
            document.querySelectorAll('section').forEach(section => {
                section.style.display = 'none';
            });
            
            // إظهار الأقسام الرئيسية بما في ذلك .hero
            const heroSection = document.querySelector('.hero');
            const latestGamesSection = document.getElementById('latest-games');
            const topGamesSection = document.getElementById('top-games');
            const allGamesSection = document.getElementById('all-games');
            
            if (heroSection) {
                heroSection.style.display = 'block';
                console.log('قسم hero يتم إظهاره');
            } else {
                console.error('قسم hero غير موجود');
            }
            
            if (latestGamesSection) {
                latestGamesSection.style.display = 'block';
                console.log('قسم latest-games يتم إظهاره');
            }
            
            if (topGamesSection) {
                topGamesSection.style.display = 'block';
                console.log('قسم top-games يتم إظهاره');
            }
            
            if (allGamesSection) {
                allGamesSection.style.display = 'block';
                console.log('قسم all-games يتم إظهاره');
            }
            
            // إعادة عرض الألعاب
            config.filteredGames = [...config.allGames];
            displayGames(config.filteredGames, 'allGamesContainer', config.currentPage);
            
            // إعادة تهيئة شريط البحث
            const searchInput = document.getElementById('searchInput');
            const suggestionsContainer = document.getElementById('searchSuggestions');
            if (searchInput && suggestionsContainer) {
                searchInput.value = '';
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.style.display = 'none';
                document.getElementById('searchResultsCount').textContent = '';
                console.log('شريط البحث تمت إعادة تهيئته');
            } else {
                console.error('عناصر البحث غير موجودة');
            }
            
            window.scrollTo(0, 0);
        }

        // تهيئة الموقع عند التحميل
        async function initSite() {
            try {
                console.log('بدء تهيئة الموقع');
                if (!window.shortcuts) {
                    console.warn('لم يتم تحميل قاموس الاختصارات، سيتم استخدام قاموس افتراضي');
                    window.shortcuts = {};
                }
                
                config.allGames = await loadGames();
                config.filteredGames = [...config.allGames];
                
                if (config.allGames.length === 0) {
                    console.error('لم يتم تحميل أي ألعاب، تحقق من games.json');
                    alert('تعذر تحميل الألعاب، تأكد من وجود ملف games.json');
                    return;
                }
                
                const latestGames = [...config.allGames].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 4);
                displayGames(latestGames, 'latestGamesContainer');
                
                const topDownloads = [...config.allGames].sort((a, b) => b.downloads - a.downloads).slice(0, 4);
                displayGames(topDownloads, 'topDownloadsContainer');
                
                displayGames(config.filteredGames, 'allGamesContainer', config.currentPage);
                
                const searchInput = document.getElementById('searchInput');
                const suggestionsContainer = document.getElementById('searchSuggestions');
                
                if (!searchInput || !suggestionsContainer) {
                    console.error('عناصر البحث غير موجودة: searchInput أو searchSuggestions');
                    return;
                }
                
                searchInput.addEventListener('input', function() {
                    try {
                        smartSearch(this.value, true);
                    } catch (error) {
                        console.error('خطأ في حدث input:', error);
                    }
                });
                
                searchInput.addEventListener('keydown', function(e) {
                    try {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const selectedSuggestion = suggestionsContainer.querySelector('.suggestion-item.active');
                            if (selectedSuggestion) {
                                const gameId = selectedSuggestion.getAttribute('data-id');
                                const selectedGame = config.allGames.find(g => g.id == gameId);
                                if (selectedGame) {
                                    this.value = selectedGame.title;
                                    performSearch(selectedGame.title, gameId);
                                }
                            } else {
                                performSearch(this.value);
                            }
                        } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                            e.preventDefault();
                            const suggestionItems = suggestionsContainer.querySelectorAll('.suggestion-item:not(.no-results)');
                            if (suggestionItems.length === 0) return;
                            
                            let activeIndex = -1;
                            suggestionItems.forEach((item, index) => {
                                if (item.classList.contains('active')) {
                                    activeIndex = index;
                                    item.classList.remove('active');
                                }
                            });
                            
                            if (e.key === 'ArrowDown') {
                                activeIndex = (activeIndex + 1) % suggestionItems.length;
                            } else if (e.key === 'ArrowUp') {
                                activeIndex = (activeIndex - 1 + suggestionItems.length) % suggestionItems.length;
                            }
                            
                            suggestionItems[activeIndex].classList.add('active');
                        }
                    } catch (error) {
                        console.error('خطأ في حدث keydown:', error);
                    }
                });
                
                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                        suggestionsContainer.style.display = 'none';
                    }
                });
                
                const categoryFilter = document.getElementById('categoryFilter');
                if (categoryFilter) {
                    categoryFilter.addEventListener('change', function() {
                        const category = this.value;
                        config.filteredGames = category === 'all' 
                            ? [...config.allGames]
                            : config.allGames.filter(game => game.category === category);
                        
                        config.currentPage = 1;
                        searchInput.value = '';
                        suggestionsContainer.style.display = 'none';
                        document.getElementById('searchResultsCount').textContent = '';
                        displayGames(config.filteredGames, 'allGamesContainer', config.currentPage);
                    });
                }
                
                const sortBy = document.getElementById('sortBy');
                if (sortBy) {
                    sortBy.addEventListener('change', function() {
                        const sortBy = this.value;
                        config.filteredGames = [...config.filteredGames];
                        
                        if (sortBy === 'newest') {
                            config.filteredGames.sort((a, b) => new Date(b.date) - new Date(a.date));
                        } else if (sortBy === 'oldest') {
                            config.filteredGames.sort((a, b) => new Date(a.date) - new Date(b.date));
                        } else if (sortBy === 'downloads') {
                            config.filteredGames.sort((a, b) => b.downloads - a.downloads);
                        }
                        
                        config.currentPage = 1;
                        displayGames(config.filteredGames, 'allGamesContainer', config.currentPage);
                    });
                }
                
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', toggleTheme);
                }
                
                // تحميل الوضع المحفوظ أو تعيين الدارك مود كافتراضي
                const savedTheme = localStorage.getItem('theme') || 'dark';
                document.body.classList.remove('dark-mode', 'light-mode');
                document.body.classList.add(`${savedTheme}-mode`);
                const icon = document.querySelector('#themeToggle i');
                if (icon) {
                    if (savedTheme === 'dark') {
                        icon.classList.remove('fa-sun');
                        icon.classList.add('fa-moon');
                    } else {
                        icon.classList.remove('fa-moon');
                        icon.classList.add('fa-sun');
                    }
                }
                
                const yearElement = document.getElementById('year');
                if (yearElement) {
                    yearElement.textContent = new Date().getFullYear();
                }
                
                document.querySelectorAll('nav a').forEach(link => {
                    link.addEventListener('click', function(e) {
                        if (this.getAttribute('href') === '#') {
                            e.preventDefault();
                            goHome();
                        }
                    });
                });
                
                document.querySelectorAll('.footer-links a').forEach(link => {
                    link.addEventListener('click', function(e) {
                        if (this.getAttribute('href') === '#' && !this.href.includes('wa.me')) {
                            e.preventDefault();
                            goHome();
                        }
                    });
                });
                
                window.addEventListener('scroll', function() {
                    const backToTop = document.getElementById('backToTop');
                    if (backToTop) {
                        if (window.pageYOffset > 300) {
                            backToTop.classList.add('visible');
                        } else {
                            backToTop.classList.remove('visible');
                        }
                    }
                });
                
                const backToTop = document.getElementById('backToTop');
                if (backToTop) {
                    backToTop.addEventListener('click', function(e) {
                        e.preventDefault();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                }
                
                console.log('تمت تهيئة الموقع بنجاح');
            } catch (error) {
                console.error('خطأ في تهيئة الموقع:', error);
                alert('حدث خطأ أثناء تحميل الموقع، تحقق من وحدة التحكم');
            }
        }

        // تبديل الوضع (داكن/فاتح)
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.contains('dark-mode');
            body.classList.remove('dark-mode', 'light-mode');
            if (isDark) {
                body.classList.add('light-mode');
                localStorage.setItem('theme', 'light');
                document.querySelector('#themeToggle i').classList.remove('fa-moon');
                document.querySelector('#themeToggle i').classList.add('fa-sun');
            } else {
                body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                document.querySelector('#themeToggle i').classList.remove('fa-sun');
                document.querySelector('#themeToggle i').classList.add('fa-moon');
            }
        }

        // تشغيل التهيئة عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', initSite);
    </script>
</body>
</html>